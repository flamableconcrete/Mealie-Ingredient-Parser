# Story 1.1: Extract and Analyze Unparsed Ingredient Patterns

## Status

**Ready for Review**

## Story

**As a** system administrator,
**I want** the application to analyze all unparsed ingredients and identify unique unit/food patterns,
**so that** I can understand the scope of batch processing opportunities before building UI.

## Acceptance Criteria

1. System extracts all unparsed ingredients from loaded recipes and identifies those missing `unit.id` or `food.id`
2. System groups ingredients by unparsed unit text (case-insensitive, trimmed whitespace)
3. System groups ingredients by unparsed food text (case-insensitive, trimmed whitespace)
4. Grouping logic creates data structures containing: pattern text, list of affected ingredient IDs, list of affected recipe IDs
5. Pattern analysis runs during existing LoadingScreen data fetch phase without blocking UI
6. Unit tests validate grouping logic with edge cases: empty strings, special characters, Unicode, whitespace variations

## Tasks / Subtasks

- [x] **Task 1: Create `PatternGroup` data model** (AC: 4)
  - [x] Create `mealie_parser/models/__init__.py` file
  - [x] Create `mealie_parser/models/pattern.py` file
  - [x] Define `PatternGroup` dataclass with fields: `pattern_text`, `ingredient_ids`, `recipe_ids`, `suggested_similar_patterns`, `operation_status`
  - [x] Add type hints for all fields
  - [x] Implement `__post_init__` validation for non-empty pattern_text
  - [x] Add `to_dict()` and `from_dict()` methods for serialization

- [x] **Task 2: Create `PatternAnalyzer` service** (AC: 1, 2, 3, 4)
  - [x] Create `mealie_parser/services/__init__.py` file
  - [x] Create `mealie_parser/services/pattern_analyzer.py` file
  - [x] Implement `extract_unparsed_ingredients(recipes)` method that uses `is_recipe_unparsed()` logic
  - [x] Implement `group_by_unit_pattern(ingredients)` method with case-insensitive, whitespace-normalized grouping
  - [x] Implement `group_by_food_pattern(ingredients)` method with case-insensitive, whitespace-normalized grouping
  - [x] Return list of `PatternGroup` objects from grouping methods

- [x] **Task 3: Integrate pattern analysis into LoadingScreen** (AC: 5)
  - [x] Import `PatternAnalyzer` into `mealie_parser/screens/loading.py`
  - [x] After fetching recipes in `load_data()`, instantiate `PatternAnalyzer`
  - [x] Call `extract_unparsed_ingredients()` on all recipes
  - [x] Call `group_by_unit_pattern()` and `group_by_food_pattern()` on extracted ingredients
  - [x] Store pattern groups in screen state for later use
  - [x] Add logging to report pattern analysis results (e.g., "Found X unique unit patterns, Y unique food patterns")

- [x] **Task 4: Write unit tests for `PatternGroup` model** (AC: 6)
  - [x] Create `tests/unit/__init__.py` file
  - [x] Create `tests/unit/test_pattern_model.py` file
  - [x] Test `PatternGroup` creation with valid data
  - [x] Test validation raises error for empty pattern_text
  - [x] Test serialization with `to_dict()` and `from_dict()`
  - [x] Test edge cases: Unicode characters, special characters, very long pattern text

- [x] **Task 5: Write unit tests for `PatternAnalyzer` service** (AC: 1, 2, 3, 4, 6)
  - [x] Create `tests/unit/test_pattern_analyzer.py` file
  - [x] Create pytest fixture with sample recipe data (unparsed ingredients)
  - [x] Test `extract_unparsed_ingredients()` correctly identifies ingredients missing unit.id or food.id
  - [x] Test `group_by_unit_pattern()` with case variations ("TSP", "tsp", "Tsp")
  - [x] Test `group_by_unit_pattern()` with whitespace variations (" tsp ", "tsp", "  tsp")
  - [x] Test `group_by_food_pattern()` with similar variations
  - [x] Test that grouping creates correct ingredient_ids and recipe_ids lists
  - [x] Test empty ingredient lists return empty pattern groups
  - [x] Test special characters and Unicode in pattern text

## Dev Notes

### Previous Story Insights
No previous story exists. This is the first story in Epic 1.

### Architecture Context

**Tech Stack:**
[Source: [docs/architecture/tech-stack.md](docs/architecture/tech-stack.md)]
- **Python**: >=3.13 with modern type hints
- **Testing**: pytest + pytest-asyncio for async testing
- **Type Checking**: mypy for static type analysis
- **Data Models**: Python dataclasses (no ORM needed)

**Project Structure:**
[Source: [docs/architecture/project-structure.md](docs/architecture/project-structure.md)]
- **New Data Models**: Place in `mealie_parser/models/` directory
  - Create `mealie_parser/models/__init__.py`
  - Create `mealie_parser/models/pattern.py` for `PatternGroup` data class
- **New Services**: Place in `mealie_parser/services/` directory
  - Create `mealie_parser/services/__init__.py`
  - Create `mealie_parser/services/pattern_analyzer.py` for pattern extraction/grouping logic
- **Unit Tests**: Place in `tests/unit/` directory
  - Create `tests/unit/test_pattern_model.py`
  - Create `tests/unit/test_pattern_analyzer.py`

**Existing Utilities:**
[Source: [mealie_parser/utils.py](mealie_parser/utils.py)]
- `is_recipe_unparsed(recipe_ingredients)`: Checks if a recipe has unparsed ingredients (has `note`/`originalText` but no `food.id` or `unit.id`)
- Pattern extraction logic should reuse similar logic to identify unparsed ingredients

**Data Flow:**
[Source: [docs/architecture/data-flow.md](docs/architecture/data-flow.md)]
- LoadingScreen currently fetches: recipes, units, foods
- Pattern analysis should run **after** recipe fetching, **before** pushing to next screen
- Use `asyncio.create_task()` pattern for non-blocking async operations
- Pass pattern groups to subsequent screens via constructor parameters

**State Management:**
[Source: [docs/architecture/state-management.md](docs/architecture/state-management.md)]
- Use Python dataclasses for data models
- PatternGroup should support serialization via `to_dict()` and `from_dict()` methods for future state persistence
- Follow the serialization pattern from `SessionState` example

**Coding Standards:**
[Source: [docs/architecture/developer-standards.md](docs/architecture/developer-standards.md)]
- **Always use type hints** on all functions, methods, and variables
- **Import pattern**: Use `from __future__ import annotations` for forward references
- **File naming**: `snake_case.py` for files, `PascalCase` for classes
- **No print statements**: Use Python logging module
- **Dataclass pattern**: Use `@dataclass` decorator with `field(default_factory=...)` for mutable defaults

### Data Models

**PatternGroup Data Class:**
[Source: [docs/architecture/project-structure.md](docs/architecture/project-structure.md#L21)]

Required fields:
- `pattern_text: str` - The normalized pattern text (e.g., "tsp", "chicken breast")
- `ingredient_ids: list[str]` - List of ingredient IDs that match this pattern
- `recipe_ids: list[str]` - List of recipe IDs containing ingredients with this pattern
- `suggested_similar_patterns: list[str]` - List of potentially related patterns (empty for Story 1.1, populated in Story 1.2)
- `operation_status: str` - One of: "pending", "processing", "completed", "skipped"

**Validation Requirements:**
- `pattern_text` must not be empty string
- `ingredient_ids` and `recipe_ids` must be lists (can be empty)
- Must implement `to_dict()` and `from_dict()` for JSON serialization

### Pattern Analysis Logic

**Normalization Strategy:**
[Source: AC 2, 3 from epic-1-batch-processing-foundation-pattern-analysis.md]
- Convert to lowercase: `pattern_text.lower()`
- Trim whitespace: `pattern_text.strip()`
- Group ingredients by normalized pattern
- Preserve original pattern text in ingredient metadata for display

**Extraction Strategy:**
[Source: [mealie_parser/utils.py:4](mealie_parser/utils.py#L4)]
- Ingredient is unparsed if:
  - Has `note` or `originalText` field
  - Missing `food.id` (for food patterns)
  - Missing `unit.id` (for unit patterns)

### Testing Requirements

[Source: [docs/architecture/testing-requirements.md](docs/architecture/testing-requirements.md)]

**Test File Locations:**
- Unit tests: `tests/unit/test_pattern_analyzer.py`, `tests/unit/test_pattern_model.py`
- Follow pytest conventions with `test_` prefix

**Test Structure:**
- Use Arrange-Act-Assert pattern
- Create fixtures for sample data in test files
- Test edge cases explicitly mentioned in AC 6

**Required Test Coverage:**
- PatternGroup model validation
- Case-insensitive grouping
- Whitespace normalization
- Empty strings handling
- Special characters (e.g., `"café"`, `"jalapeño"`)
- Unicode handling
- Empty ingredient lists

**Testing Commands:**
```bash
# Run all unit tests
pytest tests/unit/

# Run with coverage
pytest tests/unit/ --cov=mealie_parser/models --cov=mealie_parser/services

# Run specific test file
pytest tests/unit/test_pattern_analyzer.py -v
```

### Integration Points

**LoadingScreen Integration:**
[Source: [docs/architecture/data-flow.md](docs/architecture/data-flow.md#L14-L20)]

Current LoadingScreen flow:
1. `on_mount()` → `asyncio.create_task(load_data())`
2. `load_data()` fetches recipes, units, foods
3. Checks each recipe with `is_recipe_unparsed()`
4. Pushes to next screen (RecipeListScreen or ModeSelectionScreen)

**New pattern analysis step:**
- After fetching all recipes and before pushing to next screen
- Create `PatternAnalyzer` instance
- Extract unparsed ingredients from all recipes
- Group by unit patterns and food patterns
- Store pattern groups in screen state or pass to next screen
- Log summary: "Pattern analysis complete: X unit patterns, Y food patterns found"

### File Paths Summary

**New Files to Create:**
- `mealie_parser/models/__init__.py`
- `mealie_parser/models/pattern.py`
- `mealie_parser/services/__init__.py`
- `mealie_parser/services/pattern_analyzer.py`
- `tests/unit/__init__.py`
- `tests/unit/test_pattern_model.py`
- `tests/unit/test_pattern_analyzer.py`

**Existing Files to Modify:**
- `mealie_parser/screens/loading.py` - Add pattern analysis after recipe fetching

**Files to Reference:**
- `mealie_parser/utils.py` - Contains `is_recipe_unparsed()` logic to reference
- `mealie_parser/api.py` - No modifications needed, but may reference for recipe structure understanding

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

_TBD_

### Completion Notes

- All tasks completed successfully
- 33/33 unit tests passing
- All linting (ruff) checks passing
- All type checking (mypy --strict) passing
- Pattern analysis integrated into LoadingScreen data fetch phase
- PatternGroup data model supports full serialization for future state persistence
- PatternAnalyzer correctly identifies and groups unparsed ingredients by unit and food patterns
- Case-insensitive and whitespace-normalized grouping working as expected
- Edge cases tested: Unicode characters, special characters, empty strings, very long text

### File List

**New Files Created:**
- [mealie_parser/models/__init__.py](mealie_parser/models/__init__.py)
- [mealie_parser/models/pattern.py](mealie_parser/models/pattern.py)
- [mealie_parser/services/__init__.py](mealie_parser/services/__init__.py)
- [mealie_parser/services/pattern_analyzer.py](mealie_parser/services/pattern_analyzer.py)
- [tests/__init__.py](tests/__init__.py)
- [tests/unit/__init__.py](tests/unit/__init__.py)
- [tests/unit/test_pattern_model.py](tests/unit/test_pattern_model.py)
- [tests/unit/test_pattern_analyzer.py](tests/unit/test_pattern_analyzer.py)

**Modified Files:**
- [mealie_parser/screens/loading.py](mealie_parser/screens/loading.py) - Added pattern analysis integration

---

## QA Results

_This section will be populated by QA Agent after story implementation._
